@model CelularesMarket.Models.Venta

@{
    ViewData["Title"] = "Registrar Venta";
}

<h2>@ViewData["Title"]</h2>

<div class="row">
    <div class="col-md-6">
        <form asp-action="RegistrarVenta" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="mb-3">
                <label asp-for="CelularId" class="form-label">Celular</label>
                <select asp-for="CelularId" class="form-select" asp-items="ViewBag.CelularesSelectList">
                    <option value="">-- Seleccione un Celular --</option>
                </select>
                <span asp-validation-for="CelularId" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="NombreCliente" class="form-label">Nombre del Cliente</label>
                <input asp-for="NombreCliente" class="form-control" />
                <span asp-validation-for="NombreCliente" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="DocumentoCliente" class="form-label">Documento del Cliente</label>
                <input asp-for="DocumentoCliente" class="form-control" />
                <span asp-validation-for="DocumentoCliente" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="PrecioVenta" class="form-label">Precio de Venta</label>
                <input asp-for="PrecioVenta" class="form-control" readonly />
                <span asp-validation-for="PrecioVenta" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="FechaVenta" class="form-label">Fecha de Venta</label>
                <input asp-for="FechaVenta" class="form-control" value="@(Model.FechaVenta == default(DateTime) ? DateTime.Now.ToString("yyyy-MM-dd") : Model.FechaVenta.ToString("yyyy-MM-dd"))" />
                <span asp-validation-for="FechaVenta" class="text-danger"></span>
            </div>

            <input type="hidden" asp-for="Id" />
            <button type="submit" class="btn btn-primary">Registrar Venta</button>
            <a asp-action="Catalogo" class="btn btn-secondary">Cancelar</a>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const celularSelect = document.getElementById('CelularId');
            const precioInput = document.getElementById('PrecioVenta');

            celularSelect.addEventListener('change', function () {
                const selectedId = this.value;
                
                if (!selectedId) {
                    precioInput.value = '';
                    return;
                }

                // Llamada AJAX para obtener el precio
                fetch(`/Celulares/GetPrecio/${selectedId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        precioInput.value = data.precio.toFixed(2);
                    })
                    .catch(error => {
                        console.error('Error fetching price:', error);
                        precioInput.value = 'Error';
                    });
            });

            // Si ya hay un celular seleccionado al cargar la p√°gina, dispara el evento para cargar su precio
            if (celularSelect.value) {
                celularSelect.dispatchEvent(new Event('change'));
            }
        });
    </script>
}